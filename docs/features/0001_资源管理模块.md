# 资源管理模块

## 需求描述

新增资源管理模块，支持用户上传文件，管理文件。

## 需求详情

### 1. 数据库设计

#### 1.1 新增资源表

- **表名**: `files`
- **核心字段**:
  - `id`: 主键，自增整数
  - `key`: 文件标识，字符串，唯一索引，上传文件时自动生成（使用 UUID v4）
  - `name`: 文件名称，字符串，可为空，默认取用户上传文件时的文件名
  - `type`: 文件 mimetype，字符串，上传时读取文件信息写入
  - `size`: 文件大小，整数（字节），上传时读取文件信息写入
  - `ext`: 文件后缀名，字符串，可为空，上传时读取文件信息写入
  - `private`: 是否不公开，布尔值，默认 false
  - `user_id`: 上传者id，整数，外键关联 users 表，可为空
  - `created_at`: 创建时间，时间戳
  - `updated_at`: 更新时间，时间戳

- **索引**:
  - `key` 字段唯一索引（用于快速查找文件）
  - `user_id` 索引（用于查询用户文件）
  - `created_at` 索引（用于时间范围查询）

#### 1.2 数据库迁移文件

- **文件路径**: `server/migrations/YYYYMMDDHHMMSS-create-files.cjs`
- **参考**: `server/migrations/20241202000000-create-apps.cjs`
- **外键约束**: `user_id` 关联 `users.id`，`onUpdate: 'CASCADE'`, `onDelete: 'SET NULL'`

#### 1.3 Sequelize 模型

- **文件路径**: `server/models/File.ts`
- **参考**: `server/models/App.ts`
- **关联关系**: 与 `User` 模型建立关联（belongsTo）

### 2. 后端 API 接口

#### 2.1 上传接口

- **路径**: `POST /api/user/files`
- **鉴权**: 需要登录（通过 `/api/user/*` 路由自动鉴权）
- **请求格式**: `multipart/form-data`
- **功能**:
  - 接收文件上传
  - 文件存放在 `uploads/` 目录下（添加到 `.gitignore`）
  - 文件标识（key）使用 UUID v4 生成，作为存放到 `uploads/` 下的文件名（不带后缀）
  - 文件元信息（原始文件名、mimetype、大小、后缀）存储在数据库中
- **文件验证**（从 `runtimeConfig.fileUpload` 读取配置）:
  - 文件大小限制（默认 10MB）
  - mimetype 白名单（空数组表示不限制）
  - mimetype 黑名单
  - ext 白名单（空数组表示不限制）
  - ext 黑名单
- **响应**: 返回文件信息（id, key, name, type, size, ext, private, createdAt）

#### 2.2 文件访问接口

- **路径**: `GET /file/:key`
- **功能**:
  - 根据 key 查询文件记录
  - 如果 `private=true`，需要登录鉴权，且只能访问自己的文件
  - 如果 `private=false`，无需登录即可访问
  - 返回文件内容，设置正确的 `Content-Type` 响应头
  - 支持浏览器直接访问和下载

#### 2.3 删除文件接口

- **路径**: `DELETE /api/user/files`
- **鉴权**: 需要登录
- **请求体**: `{ ids: number[] }` - 文件 ID 数组
- **功能**:
  - 支持批量删除
  - 只能删除自己的文件（验证 `user_id`）
  - 删除数据库记录和物理文件
  - 如果文件不存在或不属于当前用户，跳过该文件并记录错误

#### 2.4 查询文件列表接口

- **路径**: `GET /api/user/files`
- **鉴权**: 需要登录
- **查询参数**:
  - `page`: 页码（默认 1）
  - `pageSize`: 每页数量（默认 10，最大 100）
  - `name`: 文件名（模糊搜索）
  - `startTime`: 开始时间（Unix 时间戳，秒）
  - `endTime`: 结束时间（Unix 时间戳，秒）
  - `private`: 是否公开（可选，布尔值）
- **功能**:
  - 分页查询
  - 只返回当前用户的文件
  - 支持筛选：文件名（模糊）、上传时间范围、是否公开
  - 按创建时间倒序排列
- **响应**: 返回文件列表和分页信息

#### 2.5 编辑文件接口

- **路径**: `PUT /api/user/files/:id`
- **鉴权**: 需要登录
- **请求体**: `{ name?: string, private?: boolean }`
- **功能**:
  - 修改文件名（name）
  - 修改公开状态（private）
  - 只能编辑自己的文件（验证 `user_id`）
- **验证**: 使用 Zod schema 验证参数

#### 2.6 参数验证 Schema

- **文件路径**: `server/utils/validation/files.ts`
- **参考**: `server/utils/validation/apps.ts`
- **定义**:
  - `uploadFileSchema`: 上传接口验证（文件对象）
  - `listFilesSchema`: 查询列表验证（查询参数）
  - `updateFileSchema`: 编辑文件验证（请求体）
  - `deleteFilesSchema`: 删除文件验证（请求体）

### 3. 配置文件

#### 3.1 RuntimeConfig 配置

在 `nuxt.config.ts` 的 `runtimeConfig` 中添加：

```typescript
fileUpload: {
  maxSize: 10 * 1024 * 1024, // 10MB，文件大小限制
  mimeTypeWhitelist: [], // mimetype 白名单，空数组表示不限制
  mimeTypeBlacklist: [], // mimetype 黑名单
  extWhitelist: [], // 文件后缀白名单，空数组表示不限制
  extBlacklist: [], // 文件后缀黑名单
}
```

#### 3.2 .gitignore 更新

添加 `uploads/` 目录到 `.gitignore`，确保上传的文件不会被提交到版本控制。

### 4. 前端实现

#### 4.1 类型定义

- **文件路径**: `shared/types/file.ts`
- **参考**: `shared/types/app.ts`
- **类型定义**:

```typescript
export type File = {
  id: number
  key: string
  name: string | null
  type: string
  size: number
  ext: string | null
  private: boolean
  userId: number | null
  createdAt: string
  updatedAt: string
}
```

#### 4.2 新增资源页面

- **文件路径**: `pages/workspace/assets.vue`
- **参考**: `pages/workspace/apps.vue`
- **页面结构**:
  - **筛选区**:
    - 文件名输入框（模糊搜索）
    - 上传时间范围选择器
    - 是否公开下拉选择
    - 搜索和重置按钮
  - **按钮区**:
    - 上传文件按钮（打开文件选择对话框）
    - 批量删除按钮（选中文件后显示）
  - **内容区**:
    - 文件列表（使用 `AppAssetsItem` 组件）
    - 空状态提示
    - 加载状态
  - **分页器**:
    - 支持切换每页数量和页码
- **功能**:
  - 文件上传（使用 Element Plus 的 Upload 组件）
  - 文件列表查询和筛选
  - 批量选择（checkbox）
  - 批量删除
  - 单个文件编辑和删除
  - 分页

#### 4.3 AppAssetsItem 组件

- **文件路径**: `components/AppAssetsItem.vue`
- **参考**: `components/AppAppCard.vue`
- **组件结构**:
  - **左上角 checkbox**: 支持批量选择
  - **预览区**:
    - 使用 `AppAssetsPreview` 组件
    - 尺寸比例 3:2
  - **信息区**:
    - 第一行：文件名（可显示完整名称，过长时省略）
    - 第二行：文件大小标签（默认样式）、mimetype 标签（默认样式）、private 标签（公开显示绿色，私有显示主题色）
    - 第三行：上传时间（格式：YYYY-MM-DD HH:mm:ss）
  - **控件区**:
    - 复制按钮（复制文件访问链接）
    - 打开按钮（新窗口打开文件链接）
    - 编辑按钮（派发 `edit` 事件）
    - 删除按钮（派发 `delete` 事件）
    - 样式参考 `AppAppCard` 组件（按钮使用 text 类型，使用分隔线）
- **Props**: `file: File`, `selected?: boolean`
- **Emits**: `edit`, `delete`, `update:selected`

#### 4.4 AppAssetsPreview 组件

- **文件路径**: `components/AppAssetsPreview.vue`
- **组件功能**:
  - **图片类型**:
    - 判断 `type` 是否以 `image/` 开头
    - 显示图片预览（使用文件访问链接）
    - 图片尺寸适应容器，保持 3:2 比例
  - **其他类型**:
    - 显示主题色文件图标（使用 Element Plus 图标）
    - 背景色为主题色 0.05 透明度
    - 居中显示
- **Props**: `file: File`
- **暂不做其他类型文件的预览能力**（如 PDF、视频等）

#### 4.5 更新 workspace 菜单配置

- **文件路径**: `app.config.ts`
- **在 `workspaceMenu` 数组中添加**:

```typescript
{
  label: '资源',
  icon: 'Folder',
  path: '/workspace/assets',
}
```

### 5. 技术实现细节

#### 5.1 文件标识生成

- 使用 `crypto.randomUUID()`（Node.js 内置）生成 UUID v4
- 格式示例: `550e8400-e29b-41d4-a716-446655440000`
- 作为文件名存储在 `uploads/` 目录下（不带原始后缀）

#### 5.2 文件存储

- 存储路径: `uploads/{key}`（key 为 UUID，不带后缀）
- 文件元信息（包括原始文件名、后缀、mimetype）存储在数据库中
- 文件访问时通过数据库查询获取原始文件名和类型

#### 5.3 文件上传处理

- 使用 Nuxt 的 `readMultipartFormData` API 处理文件上传
- 或使用 `formidable` 库（如需要更复杂的处理）
- 文件验证在保存前进行，验证失败不保存文件

#### 5.4 文件访问安全

- 公开文件（`private=false`）: 无需登录，直接访问
- 私有文件（`private=true`）:
  - 需要登录鉴权
  - 只能访问自己的文件（验证 `user_id`）
  - 访问其他用户的私有文件返回 403

#### 5.5 文件删除

- 硬删除：同时删除数据库记录和物理文件
- 删除前验证文件所有权
- 批量删除时，部分失败不影响其他文件的删除

### 6. 安全性考虑

1. **文件上传安全**:
   - 验证文件类型和大小
   - 防止路径遍历攻击（确保 key 不包含路径分隔符）
   - 限制上传频率（可选，暂不实现）

2. **文件访问安全**:
   - 私有文件需要鉴权
   - 验证文件所有权
   - 防止未授权访问

3. **错误处理**:
   - 统一的错误响应格式
   - 友好的错误提示
   - 不暴露敏感信息

### 7. 实现顺序建议

1. **数据库层**:
   - 创建 migration 文件
   - 创建 File 模型
   - 更新模型关联关系

2. **后端 API**:
   - 实现参数验证 schema
   - 实现上传接口
   - 实现查询列表接口
   - 实现编辑接口
   - 实现删除接口
   - 实现文件访问接口

3. **配置文件**:
   - 更新 `nuxt.config.ts` 添加 fileUpload 配置
   - 更新 `.gitignore` 添加 uploads 目录

4. **前端类型**:
   - 定义 File 类型

5. **前端组件**:
   - 实现 `AppAssetsPreview` 组件
   - 实现 `AppAssetsItem` 组件

6. **前端页面**:
   - 实现 `pages/workspace/assets.vue` 页面

7. **菜单配置**:
   - 更新 `app.config.ts` 添加资源菜单项

### 8. 测试要点

1. **文件上传**:
   - 正常上传各种类型文件
   - 文件大小超限验证
   - 文件类型白/黑名单验证
   - 文件后缀白/黑名单验证

2. **文件访问**:
   - 公开文件无需登录访问
   - 私有文件需要登录访问
   - 私有文件所有权验证

3. **文件管理**:
   - 查询列表和筛选
   - 编辑文件名和公开状态
   - 单个删除和批量删除
   - 文件所有权验证

4. **前端功能**:
   - 文件上传 UI
   - 文件列表展示
   - 批量选择和删除
   - 文件预览（图片）
