# 代码管理功能

## 需求描述

新增代码管理功能，支持用户为应用创建和管理代码（模板、脚本、样式），并在应用创作页面实现代码的自动保存和回显。

## 需求详情

### 1. 数据库设计

#### 1.1 新增代码表

- **表名**: `codes`
- **核心字段**:
  - `id`: 主键，自增整数
  - `user_id`: 用户id，整数，外键关联 users 表，不可为空
  - `type`: 代码类型，枚举值（'template' | 'script' | 'style'），不可为空
  - `content`: 代码内容，文本类型（TEXT），可为空，默认空字符串
  - `app_id`: 应用id，整数，外键关联 apps 表，可为空（非必填）
  - `created_at`: 创建时间，时间戳
  - `updated_at`: 更新时间，时间戳

- **索引**:
  - `user_id` 索引（用于查询用户代码）
  - `app_id` 索引（用于查询应用代码）
  - `type` 索引（用于按类型查询）
  - `(user_id, app_id, type)` 联合唯一索引（确保同一用户同一应用同一类型只有一条记录）

#### 1.2 扩展应用表字段

- **表名**: `apps`
- **新增字段**:
  - `template_code_id`: 模板代码id，整数，外键关联 codes 表，可为空
  - `style_code_id`: 样式代码id，整数，外键关联 codes 表，可为空
  - `script_code_id`: 脚本代码id，整数，外键关联 codes 表，可为空

- **外键约束**:
  - `template_code_id` 关联 `codes.id`，`onUpdate: 'CASCADE'`, `onDelete: 'SET NULL'`
  - `style_code_id` 关联 `codes.id`，`onUpdate: 'CASCADE'`, `onDelete: 'SET NULL'`
  - `script_code_id` 关联 `codes.id`，`onUpdate: 'CASCADE'`, `onDelete: 'SET NULL'`

#### 1.3 数据库迁移文件

- **文件路径**: `server/migrations/YYYYMMDDHHMMSS-create-codes.cjs`
- **参考**: `server/migrations/20241202000000-create-apps.cjs`
- **外键约束**:
  - `user_id` 关联 `users.id`，`onUpdate: 'CASCADE'`, `onDelete: 'CASCADE'`
  - `app_id` 关联 `apps.id`，`onUpdate: 'CASCADE'`, `onDelete: 'SET NULL'`

- **文件路径**: `server/migrations/YYYYMMDDHHMMSS-add-code-ids-to-apps.cjs`
- **功能**: 为 apps 表添加三个代码关联字段

#### 1.4 Sequelize 模型

- **文件路径**: `server/models/Code.ts`
- **参考**: `server/models/App.ts`
- **关联关系**:
  - 与 `User` 模型建立关联（belongsTo）
  - 与 `App` 模型建立关联（belongsTo，可选）
  - `App` 模型与 `Code` 模型建立关联（hasOne，三个关联）

### 2. 后端 API 接口

#### 2.1 创建或更新代码接口

- **路径**: `PUT /api/user/codes`
- **鉴权**: 需要登录（通过 `/api/user/*` 路由自动鉴权）
- **请求体**:
  ```typescript
  {
    id?: number // 代码id，更新对应 id 的代码
    appId?: number  // 应用id，可选
    type: 'template' | 'script' | 'style'  // 代码类型
    content: string  // 代码内容
  }
  ```
- **功能**:
  - **如果提供了 `id`**:
    - 根据 `id` 查找代码，验证代码属于当前用户（验证 `user_id`）
    - 如果代码不存在或不属于当前用户，返回 404 或 403 错误
    - 更新代码的 `content` 和 `updated_at` 字段
    - 如果同时提供了 `appId` 和 `type`，建议验证是否与代码记录一致（可选，用于数据一致性检查）
  - **如果未提供 `id`**:
    - 根据 `userId`、`appId`、`type` 查询是否存在
    - 如果代码不存在，则创建新记录
    - 如果代码已存在，则更新 `content` 和 `updated_at`
  - **通用逻辑**:
    - 如果 `appId` 存在，需要验证应用属于当前用户
    - 如果创建了新代码且 `appId` 存在，需要更新应用表对应的代码关联字段
  - **响应**: 返回更新后的代码信息（包含 `id`，用于前端后续更新）

#### 2.2 查询代码接口

- **路径**: `GET /api/user/codes`
- **鉴权**: 需要登录
- **查询参数**:
  - `appId`: 应用id（可选，如果提供则只查询该应用的代码）
  - `type`: 代码类型（可选，'template' | 'script' | 'style'）
- **功能**:
  - 只返回当前用户的代码
  - 支持按应用id和类型筛选
  - 返回代码列表（包含 id, type, content, appId, createdAt, updatedAt）

#### 2.3 删除代码接口

- **路径**: `DELETE /api/user/codes/:id`
- **鉴权**: 需要登录
- **功能**:
  - 只能删除自己的代码（验证 `user_id`）
  - 删除前需要检查是否有应用关联此代码，如果有，需要将应用表的对应字段设置为 NULL
  - 删除代码记录

#### 2.4 更新应用查询接口

- **路径**: `GET /api/user/apps/name/[name]`
- **修改内容**:
  - 查询应用时，同时查询关联的代码信息（templateCode, styleCode, scriptCode）
  - 返回数据中包含代码内容（如果存在）
- **响应格式扩展**:
  ```typescript
  {
    success: boolean
    message: string
    data: {
      id: number
      name: string
      title: string
      userId: number
      createdAt: number
      updatedAt: number
      templateCode?: {
        id: number
        content: string
        updatedAt: number
      }
      styleCode?: {
        id: number
        content: string
        updatedAt: number
      }
      scriptCode?: {
        id: number
        content: string
        updatedAt: number
      }
    }
  }
  ```

#### 2.5 参数验证 Schema

- **文件路径**: `server/utils/validation/codes.ts`
- **参考**: `server/utils/validation/apps.ts`
- **定义**:
  - `createOrUpdateCodeSchema`: 创建或更新代码验证（请求体）
    - `id`: 可选，正整数（如果提供，则用于直接更新指定代码）
    - `appId`: 可选，正整数
    - `type`: 必填，枚举值（'template' | 'script' | 'style'）
    - `content`: 必填，字符串
  - `listCodesSchema`: 查询代码列表验证（查询参数）

### 3. 前端实现

#### 3.1 类型定义

- **文件路径**: `shared/types/code.ts`
- **类型定义**:

  ```typescript
  export type CodeType = 'template' | 'script' | 'style'

  export type Code = {
    id: number
    userId: number
    type: CodeType
    content: string
    appId: number | null
    createdAt: string
    updatedAt: string
  }
  ```

- **文件路径**: `shared/types/app.ts`
- **修改内容**: 扩展 `App` 类型，添加代码字段

  ```typescript
  export type AppCode = {
    id: number
    content: string
    updatedAt: string
  }

  export type App = {
    id: number
    name: string
    title: string
    userId: number
    createdAt: string
    updatedAt: string
    templateCode?: AppCode
    styleCode?: AppCode
    scriptCode?: AppCode
  }
  ```

#### 3.2 更新 CodePanel 组件

- **文件路径**: `components/editor/CodePanel.vue`
- **修改内容**:
  - 添加 `appId` prop（可选，用于关联应用）
  - 添加 `codeId` prop（可选，用于标识已有代码的 id，用于更新）
  - 添加自动保存功能：
    - 监听代码变化（`watch` 或 `onDidChangeModelContent`）
    - 使用防抖（debounce），3秒无编辑动作后自动保存
    - 保存时调用创建或更新代码接口
    - **保存逻辑**:
      - 如果 `codeId` 存在，在请求体中传递 `id: codeId` 进行更新
      - 如果 `codeId` 不存在，不传递 `id`，由后端根据 `userId`、`appId`、`type` 查找或创建
      - 保存成功后，保存返回的 `id` 到 `codeId`，用于后续更新
  - 添加保存状态显示：
    - 保存中：显示 loading 图标（使用 Element Plus 的 `Loading` 图标）
    - 保存成功：显示成功图标（使用 Element Plus 的 `CircleCheck` 图标）+ "已保存" + 保存时间（格式：HH:mm:ss）
    - 保存失败：显示错误提示（使用 Element Plus 的 `ElMessage`）
  - 在头部右侧（`panel-top-actions` 区域）显示保存状态

#### 3.3 更新 Code 组件

- **文件路径**: `components/editor/Code.vue`
- **修改内容**:
  - 添加 `appId` prop，传递给各个 `CodePanel` 组件
  - 添加 `templateCode`、`styleCode`、`scriptCode` props，用于回显代码内容
  - 将代码内容传递给对应的 `CodePanel` 组件
  - 将代码 id（如果存在）传递给对应的 `CodePanel` 组件作为 `codeId`

#### 3.4 更新应用创作页面

- **文件路径**: `pages/workspace/app/[name].vue`
- **修改内容**:
  - 从 API 响应中获取代码信息（templateCode, styleCode, scriptCode）
  - 将 `app.id` 传递给 `EditorCode` 组件作为 `appId`
  - 将代码内容传递给 `EditorCode` 组件用于回显
  - 实现代码回显逻辑：页面加载时，如果有代码内容，自动填充到编辑器中

### 4. 技术实现细节

#### 4.1 自动保存实现

- 使用 Vue 的 `watch` 监听代码值变化
- 使用防抖函数（debounce），延迟 3 秒执行保存
- 保存前取消上一次的防抖定时器，确保只有最后一次编辑后的 3 秒才保存
- 保存过程中显示 loading 状态，防止重复保存
- **保存逻辑**:
  - 首次保存（无 `codeId`）：不传递 `id`，由后端创建新记录，保存返回的 `id`
  - 后续保存（有 `codeId`）：传递 `id: codeId`，直接更新指定代码，性能更优
- **状态管理**:
  - 维护 `codeId` 状态，保存成功后更新，用于后续更新操作

#### 4.2 保存状态管理

- 使用响应式状态管理保存状态：
  - `saving`: 是否正在保存（boolean）
  - `saveStatus`: 保存状态（'idle' | 'saving' | 'success' | 'error'）
  - `lastSavedAt`: 最后保存时间（Date | null）
- 保存成功后，更新 `lastSavedAt` 并显示成功状态
- 成功状态显示 3 秒后自动隐藏（可选，或保持显示直到下次编辑）

#### 4.3 代码回显实现

- 页面加载时，从应用数据中获取代码内容
- 通过 props 传递给 `Code` 组件，再传递给各个 `CodePanel` 组件
- `CodePanel` 组件在初始化时，如果有 `modelValue`，设置到编辑器中
- 注意：回显时不应该触发自动保存

#### 4.4 代码类型枚举

- 使用 TypeScript 字面量类型确保类型安全
- 代码类型：'template' | 'script' | 'style'
- 在验证 schema 中使用 `z.enum()` 验证

#### 4.5 数据库唯一性约束

- 使用联合唯一索引确保同一用户、同一应用、同一类型只有一条代码记录
- 在 Sequelize 中使用 `unique: 'unique_user_app_type'` 或迁移文件中添加唯一索引

### 5. 安全性考虑

1. **权限验证**:
   - 只能创建、更新、删除自己的代码
   - 关联应用时，验证应用属于当前用户
   - **通过 `id` 更新时**：必须验证代码的 `user_id` 与当前用户 id 一致，防止越权更新

2. **数据验证**:
   - 使用 Zod schema 验证请求参数
   - 验证代码类型枚举值
   - 验证应用id存在且属于当前用户

3. **错误处理**:
   - 统一的错误响应格式
   - 友好的错误提示
   - 保存失败时显示错误信息

### 6. 实现顺序建议

1. **数据库层**:
   - 创建 codes 表迁移文件
   - 创建扩展 apps 表迁移文件
   - 创建 Code 模型
   - 更新 App 模型（添加关联字段）
   - 更新模型关联关系

2. **后端 API**:
   - 实现参数验证 schema
   - 实现创建或更新代码接口
   - 实现查询代码接口
   - 实现删除代码接口
   - 更新应用查询接口（包含代码信息）

3. **前端类型**:
   - 定义 Code 类型
   - 更新 App 类型

4. **前端组件**:
   - 更新 `CodePanel` 组件（自动保存、状态显示）
   - 更新 `Code` 组件（传递 appId 和代码内容）

5. **前端页面**:
   - 更新应用创作页面（代码回显）

### 7. 测试要点

1. **数据库**:
   - 代码表创建成功
   - 应用表字段扩展成功
   - 外键约束正确
   - 唯一索引生效

2. **后端接口**:
   - 创建代码成功（不提供 `id`）
   - 通过 `id` 更新代码成功
   - 通过 `userId`、`appId`、`type` 更新代码成功（不提供 `id`）
   - 通过 `id` 更新时，权限验证正确（不能更新其他用户的代码）
   - 查询代码列表成功
   - 删除代码成功
   - 应用查询包含代码信息
   - 权限验证正确

3. **前端功能**:
   - 代码编辑后 3 秒自动保存
   - 首次保存后，正确保存返回的 `id` 用于后续更新
   - 后续保存时，正确传递 `id` 进行更新
   - 保存状态正确显示（loading、成功、时间）
   - 代码回显正确（包括代码内容和 `id`）
   - 多个代码面板独立保存
   - 保存失败时显示错误提示

4. **边界情况**:
   - 代码内容为空时的处理
   - 应用不存在时的处理
   - 网络错误时的处理
   - 快速连续编辑时的防抖处理
   - 通过 `id` 更新时，代码不存在或不属于当前用户的处理
   - 通过 `id` 更新时，`appId` 或 `type` 不匹配的处理（可选验证）

### 8. 注意事项

1. **代码内容大小**:
   - 使用 TEXT 类型存储代码内容，支持较大代码
   - 考虑是否需要限制代码内容长度（暂不限制）

2. **性能优化**:
   - 防抖时间设置为 3 秒，避免频繁保存
   - 保存时只发送变化的代码内容
   - 考虑是否需要批量保存多个代码（暂不实现）

3. **用户体验**:
   - 保存状态清晰可见
   - 保存时间格式友好（HH:mm:ss）
   - 保存失败时提供重试机制（可选）

4. **数据一致性**:
   - 确保应用表的代码关联字段与代码表的记录一致
   - 删除代码时，正确清理应用表的关联字段
